{% extends "blog/base.html" %}
{% load blog_tags %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <article class="post-detail card mb-4">
            <div class="card-body">
                <h1 class="card-title">{{ post.title }}</h1>
                <p class="text-muted">
                    Опубліковано {{ post.publish|date:"F d, Y" }} автором {{ post.author }}
                </p>
                <div class="post-body">
                    {{ post.body|markdown }}
                </div>
                
                {% if post.tags.all %}
                <div class="post-tags mt-3">
                    <strong>Теги:</strong>
                    {% for tag in post.tags.all %}
                        <a href="{% url 'blog:post_list_by_tag' tag.slug %}" class="badge bg-primary text-decoration-none">
                            {{ tag.name }}
                        </a>
                        {% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="share-post mt-3">
                    <a href="{% url 'blog:post_share' post.id %}" class="btn btn-primary">
                        Поділитися
                    </a>
                </div>
            </div>
        </article>

        <!-- Схожі публікації -->
        <h2>Схожі публікації</h2>
        {% for post in similar_posts %}
            <p>
                <a href="{{ post.get_absolute_url }}">{{ post.title }}</a>
            </p>
        {% empty %}
            Схожих публікацій ще немає.
        {% endfor %}

        <!-- Коментарі -->
        <div class="card">
            <div class="card-header">
                <h5>Коментарі ({{ comments.count }})</h5>
            </div>
            <div class="card-body">
                {% for comment in comments %}
                    <div class="comment mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">{{ comment.name }}</h6>
                            <small class="text-muted">{{ comment.created|date:"F d, Y H:i" }}</small>
                        </div>
                        <p class="mb-0">{{ comment.body|linebreaks }}</p>
                        {% if not forloop.last %}<hr>{% endif %}
                    </div>
                {% empty %}
                    <p class="text-muted">Ще немає коментарів. Будьте першим!</p>
                {% endfor %}

                <!-- Форма додавання коментаря -->
                <div class="mt-4">
                    <h5>Залишити коментар</h5>
                    <form method="post" class="mt-3">
                        {% csrf_token %}
                        {{ comment_form.as_p }}
                        <button type="submit" class="btn btn-primary">Надіслати</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Бічна панель -->
    <div class="col-md-4">
        <!-- Пошук -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Пошук</h5>
            </div>
            <div class="card-body">
                <form method="get" action="{% url 'blog:post_list' %}" class="d-flex">
                    <input type="text" name="query" class="form-control me-2" placeholder="Пошук...">
                    <button type="submit" class="btn btn-primary">Знайти</button>
                </form>
            </div>
        </div>

        <!-- Теги -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>Теги</h5>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap">
                    {% for tag in tags %}
                        <a href="{% url 'blog:post_list_by_tag' tag.slug %}" 
                           class="badge bg-secondary text-decoration-none me-1 mb-1">
                            {{ tag.name }}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Останні публікації -->
        <div class="card">
            <div class="card-header">
                <h5>Останні публікації</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    {% for post in recent_posts %}
                        <li class="mb-2">
                            <a href="{{ post.get_absolute_url }}" class="text-decoration-none">
                                {{ post.title }}
                            </a>
                            <div class="text-muted small">{{ post.publish|date:"F d, Y" }}</div>
                        </li>
                        {% if not forloop.last %}<hr class="my-2">{% endif %}
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
    <div class="comments-section">
      <h2>Коментарі ({{ comments.count }})</h2>
      
      {% for comment in comments %}
        <div class="comment">
          <div class="comment-header">
            <strong>{{ comment.name }}</strong>
            <span class="comment-date">{{ comment.created|date:"d.m.Y H:i" }}</span>
          </div>
          <div class="comment-body">
            {{ comment.body|linebreaks }}
          </div>
        </div>
      {% empty %}
        <p>Ще немає коментарів. Будьте першим!</p>
      {% endfor %}

      <!-- Форма додавання коментаря -->
      <div class="add-comment">
        <h3>Додати коментар</h3>
        {% if new_comment %}
          <div class="alert alert-success" role="alert">
            Ваш коментар успішно додано і очікує модерації.
          </div>
        {% else %}
          <form method="post">
            {% csrf_token %}
            {{ comment_form.as_p }}
            <button type="submit" class="btn btn-primary">Надіслати</button>
          </form>
        {% endif %}
      </div>
    </div>
    
    {% if similar_posts %}
    <div class="similar-posts">
      <h3>Схожі публікації</h3>
      <div class="similar-posts-grid">
        {% for post in similar_posts %}
        <div class="similar-post">
          <a href="{{ post.get_absolute_url }}" class="similar-post-link">
            <h4>{{ post.title }}</h4>
            <p class="similar-post-date">{{ post.publish|date:"d.m.Y" }}</p>
            <p class="similar-post-preview">
              {{ post.body|truncatewords:15|linebreaks }}
            </p>
          </a>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  </article>
{% endblock %}
